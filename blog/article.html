<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記事タイトル - ブログ / Blog - 根石 将人</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="../components/loader.js"></script>
    <link rel="stylesheet" href="../common.css">
</head>

<body class="bg-gray-50 text-gray-800 flex flex-col items-center min-h-screen">
    <!-- 固定ナビゲーションバー (JSによりcomponents/header.htmlが挿入されます) -->
    <nav id="header" class="fixed top-0 left-0 w-full bg-white shadow-sm z-50">
        <div class="max-w-4xl w-11/12 md:w-full mx-auto px-4 md:px-0 py-3 animate-pulse">
            <div class="h-8 bg-gray-200 rounded w-1/3 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
        </div>
    </nav>

    <!-- ページ全体のコンテンツ -->
    <div
        class="max-w-4xl w-11/12 md:w-full mx-auto mt-28 mb-12 bg-white p-6 sm:p-10 rounded-2xl shadow-xl ring-1 ring-gray-200/50 animate-fade-in">
        <!-- パンくずリスト -->
        <nav class="text-sm mb-8 text-gray-500">
            <a href="../index.html" class="hover:text-blue-600 transition-colors">トップ</a>
            <span class="mx-2 text-gray-300">/</span>
            <a href="../blog.html" class="hover:text-blue-600 transition-colors">ブログ</a>
            <span class="mx-2 text-gray-300">/</span>
            <span id="breadcrumb-article-title" class="text-gray-400">記事タイトル</span>
        </nav>

        <article class="prose prose-slate lg:prose-lg max-w-none">
            <!-- 記事ヘッダー -->
            <header class="mb-10 pb-8 border-b border-gray-100">
                <h1 id="article-title"
                    class="text-2xl sm:text-4xl font-extrabold text-gray-900 mb-4 tracking-tight leading-tight">
                    記事を読み込んでいます...</h1>
                <div class="flex items-center text-sm text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    公開日: <time id="article-date" class="font-medium"></time>
                </div>
            </header>

            <!-- 記事本文 -->
            <div id="article-content" class="article-body">
                <!-- Markdownから変換されたHTMLがここに挿入されます -->
            </div>
        </article>

        <!-- (任意) 記事フッター: タグ、カテゴリ、ソーシャルシェアボタンなど -->
        <footer class="mt-12 pt-6 border-t border-gray-200">
            <div class="flex justify-between items-center text-sm">
                <a href="../blog.html"
                    class="text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    ブログ一覧に戻る
                </a>
                <a href="../index.html" class="text-gray-500 hover:text-blue-600 transition-colors">
                    トップページへ
                </a>
            </div>
        </footer>
    </div>
    <!-- コードハイライト用のJS (任意で有効化) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script> -->
    <!-- <script>document.addEventListener('DOMContentLoaded', (event) => { hljs.highlightAll(); });</script> -->
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const articleTitleElement = document.getElementById('article-title');
            const articleDateElement = document.getElementById('article-date');
            const articleContentElement = document.getElementById('article-content'); // IDで取得するように変更
            const pageTitleElement = document.querySelector('title');
            const breadcrumbArticleTitleElement = document.getElementById('breadcrumb-article-title');

            // URLから記事IDを取得
            const params = new URLSearchParams(window.location.search);
            const articleId = params.get('id');

            if (!articleId) {
                displayError("記事IDが指定されていません。");
                return;
            }

            try {
                // blog/data/配下のMarkdownファイルを読み込みます
                // 記事IDにサブディレクトリ（例: 2025/）が含まれている場合にも対応
                // キャッシュを回避するためにタイムスタンプを付与
                const response = await fetch(`data/${articleId}.md?t=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for data/${articleId}.md`);
                }
                let rawText = await response.text();

                // BOM (Byte Order Mark) を除去し、前後の空白をトリミング
                rawText = rawText.replace(/^\uFEFF/, '').trim();

                // Front Matterと本文をパースする簡単な関数
                function parseMarkdownWithFrontMatter(text) {
                    const frontMatterRegex = /^---\s*([\s\S]*?)\s*---/;
                    const match = text.match(frontMatterRegex);
                    let frontMatter = {};
                    let content = text;

                    if (match) {
                        const yamlText = match[1];
                        content = text.substring(match[0].length).trimStart();
                        // 簡単なYAML風のパース (titleとdateのみを想定)
                        yamlText.split('\n').forEach(line => {
                            const parts = line.split(':');
                            if (parts.length >= 2) {
                                const key = parts[0].trim();
                                const value = parts.slice(1).join(':').trim();
                                if (key === 'title' || key === 'date') {
                                    frontMatter[key] = value;
                                }
                            }
                        });
                    }
                    return { ...frontMatter, content };
                }

                const article = parseMarkdownWithFrontMatter(rawText);

                if (article && article.title && article.date && article.content) {
                    pageTitleElement.textContent = `${article.title} - ブログ / Blog - 根石 将人`;
                    articleTitleElement.textContent = article.title;
                    if (breadcrumbArticleTitleElement) breadcrumbArticleTitleElement.textContent = article.title;

                    articleDateElement.textContent = article.date;
                    articleDateElement.datetime = article.date;

                    // Meta情報の動的な更新（SEO対応）
                    updateMetaTags(article.title, article.content.substring(0, 160).replace(/[#*`]/g, '') + '...');

                    marked.setOptions({
                        gfm: true,
                        breaks: true,
                        highlight: function (code, lang) {
                            if (lang && hljs.getLanguage(lang)) {
                                return hljs.highlight(code, { language: lang }).value;
                            }
                            return hljs.highlightAuto(code).value;
                        }
                    });

                    articleContentElement.innerHTML = marked.parse(article.content);

                    // コードハイライトの適用（手動実行が必要な場合用）
                    document.querySelectorAll('pre code').forEach((el) => {
                        hljs.highlightElement(el);
                    });

                    // 記事本文内のスタイル調整（Tailwindクラスの適用）
                    setupArticleStyles(articleContentElement);

                } else {
                    displayError(`記事データ「${articleId}」の形式が正しくありません。`);
                }
            } catch (error) {
                console.error('記事の読み込みまたは解析中にエラーが発生しました:', error);
                displayError("記事の読み込みに失敗しました。詳細はコンソールを確認してください。");
            }

            function updateMetaTags(title, description) {
                const metaTitle = `document.querySelector('meta[property="og:title"]')`;
                const metaDesc = `document.querySelector('meta[name="description"]')`;
                const ogDesc = `document.querySelector('meta[property="og:description"]')`;

                if (document.querySelector('meta[property="og:title"]')) document.querySelector('meta[property="og:title"]').content = title;
                if (document.querySelector('meta[name="description"]')) document.querySelector('meta[name="description"]').content = description;
                if (document.querySelector('meta[property="og:description"]')) document.querySelector('meta[property="og:description"]').content = description;
            }

            function setupArticleStyles(container) {
                container.querySelectorAll('ul').forEach(ul => {
                    if (!ul.closest('pre')) ul.classList.add('list-disc', 'pl-6', 'mb-6', 'space-y-2');
                });
                container.querySelectorAll('ol').forEach(ol => {
                    ol.classList.add('list-decimal', 'pl-6', 'mb-6', 'space-y-2');
                });
                container.querySelectorAll('blockquote').forEach(bq => {
                    bq.classList.add('border-l-4', 'border-blue-200', 'bg-blue-50/50', 'pl-6', 'py-4', 'my-8', 'italic', 'text-gray-700', 'rounded-r-lg');
                });
                container.querySelectorAll('h2').forEach(h2 => {
                    h2.classList.add('text-2xl', 'font-bold', 'mt-12', 'mb-6', 'pb-2', 'border-b', 'border-gray-100');
                });
                container.querySelectorAll('h3').forEach(h3 => {
                    h3.classList.add('text-xl', 'font-bold', 'mt-10', 'mb-4');
                });
                container.querySelectorAll('a').forEach(a => {
                    a.classList.add('text-blue-600', 'hover:underline', 'underline-offset-4');
                });
                container.querySelectorAll('code:not(pre code)').forEach(code => {
                    code.classList.add('bg-gray-100', 'text-blue-600', 'px-1.5', 'py-0.5', 'rounded', 'font-mono', 'text-sm');
                });
                container.querySelectorAll('pre').forEach(pre => {
                    pre.classList.add('relative', 'my-8', 'shadow-sm', 'rounded-xl', 'overflow-hidden');
                });
            }

            function displayError(message) {
                if (articleTitleElement) articleTitleElement.textContent = "エラー";
                if (breadcrumbArticleTitleElement) breadcrumbArticleTitleElement.textContent = "エラー";
                if (articleContentElement) {
                    articleContentElement.innerHTML = `<p class='text-red-600'>${message}</p>`;
                }
            }
        });
    </script>
    <!-- フッター (JSによりcomponents/footer.htmlが挿入されます) -->
    <footer id="footer"></footer>
</body>

</html>